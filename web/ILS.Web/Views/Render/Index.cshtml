@{
    ViewBag.Title = "3Ducation | Виртуальный мир";
    Layout = "~/Views/Shared/_UserLayout.cshtml";
}
@section additionalCSS {
    <link rel="stylesheet" type="text/css" href="@Url.Content("~/Content/user.css")"/>
}
@section scripts{
    <script type="text/javascript" src="http://webplayer.unity3d.com/download_webplayer-3.x/3.0/uo/UnityObject.js"></script>
    <script type="text/javascript" src="Scripts/jwp/jwplayer.js"></script>
         
    <script type="text/javascript">
        getUnityImage = '@Url.Content("~/Content/pics_service/UnitySetup.png")';
        link_unityfile = '@Url.Content("~/UnityDeploy/Main.unity3d")';
        link_unityRPG = '@Url.Action("UnityRPG", "Render")';
        link_unitylist = '@Url.Action("UnityList", "Render")';
        link_unitydata = '@Url.Action("UnityData", "Render")';
        link_unitystat = '@Url.Action("UnityStat", "Render")';
        link_unitysave = '@Url.Action("UnitySave", "Render")';
        link_unitysaveRPG = '@Url.Action("UnitySaveRPG", "Render")';
        link_unitytest = '@Url.Action("UnityTest", "Render")';

        var virtual_world = new Ext.panel.Panel({
        });
        var embedded = false;
        var width; var height;

        function startUnityPlayer() {
            if (!embedded && typeof unityObject != "undefined") {
                width = 809;
                height = 400;
                if (width < 200 || height < 200) return;
                embedded = true;

                var params = { disableContextMenu: true };
                unityObject.embedUnity("unityPlayer", link_unityfile, width, height, params);
                if (document.getElementById("unityPlayer").childNodes[0].tagName == "DIV") {
                    document.getElementById("unityPlayer").childNodes[0].style.width = "500px";
                    document.getElementById("unityPlayer").childNodes[0].childNodes[0].style.height = "125px";
                    document.getElementById("unityPlayer").childNodes[0].childNodes[0].style.top = "0px";
                    document.getElementById("unityPlayer").childNodes[0].childNodes[0].style.left = "50%";
                    document.getElementById("unityPlayer").childNodes[0].childNodes[0].style.marginLeft = "-96px";
                    document.getElementById("unityPlayer").childNodes[0].childNodes[0].title = "";
                }
                document.getElementById("unityPlayer").style.height = "1px";
                document.getElementById("unityPlayer").style.width = "1px";
				setTimeout(UnityLoaded, 10000);
            }
        }


    </script>
    <script type="text/javascript">
        var img;
        var canvas;
        var frame = 0;
        var ITHASBEGUN = false;
        window.onload = function () {

            jwplayer("videoPlayer").setup({
                flashplayer: "Scripts/jwp/player.swf",
                file: "Content/demo.flv",
                height: 400,
                width: 809
            });

            var index = frame + 1;
            image = document.getElementById("enter" + index);
            img = new Image();
            img.src = image.src;
            canvas = document.getElementById("rotate");
            canvas.width = image.width;
            canvas.height = image.height;
            img.context = canvas.getContext("2d");
            img.canvas = canvas;
            img.radians = Math.PI / 180;
            canvas_rotate.call(img, 0);

            var frameLoading = 0;
            var timerLoading;
            var framesLoading = document.getElementById("loadingContainer").children;
            function loading() {
                framesLoading[frameLoading].style.display = "none";
                frameLoading++;
                if (frameLoading == 50) {
                    frameLoading = 0;
                }
                framesLoading[frameLoading].style.display = "block";
            }
            timerLoading = setInterval(loading, 40);

            var updaterTop = -400;
            var updaterTimer;
            var updater = document.getElementById("updater");
            function update() {
                updater.style.top = updaterTop + 'px';
                updaterTop += 3;
                if (updaterTop > 800)
                    updaterTop = -400;
            }
            updaterTimer = setInterval(update, 10);

            var frameVisors = 0;
            var timerVisors;
            var framesVisors = document.getElementById("visorsContainer").children;
            function visors() {
                framesVisors[frameVisors].style.display = "none";
                frameVisors++;
                if (frameVisors == 15) {
                    frameVisors = 0;
                }
                framesVisors[frameVisors].style.display = "block";
            }
            timerVisors = setInterval(visors, 40);

            var index = document.location.href.indexOf("?action=");
            if (index != -1) {
                var action = document.location.href.slice(index + 8);
                if (action == "video")
                    demo_video();
                else if (action == "game")
                    demo_game();
            }
        }

        function canvas_rotate(rotate) {
            img.context.clearRect(0, 0, img.width, img.height);
            this.context.save();
            this.context.translate(this.width / 2, this.height / 2);
            this.context.rotate(rotate * this.radians);
            this.context.drawImage(this, -(this.width / 2), -(this.height / 2));
            this.context.restore();
        }

        var authorisationComplete = false;
        var authorisationSucceed = false;
        var authorisationNotStarted = true;
        var contentType = 0; //0 - authorise & play, 1 - demo play, 2 - demo video
		var timer;

        window.addEventListener("message", receiveMessage, false);

        function receiveMessage(event) {
            var message = JSON.parse(event.data);
            if (message.header == 'authorise')
                this.authorise(message.success, message.firstName, message.admin); 
        }

        authorise = function (success, firstName, admin) {
            authorisationComplete = true;
            if (success) {
                authorisationSucceed = true;
				document.getElementById('helloPanel').style.display = "block";
				document.getElementById('helloInactive').style.display = "none";
                document.getElementById('credentials').innerHTML = firstName;
                document.getElementById('adminLink').style.display = admin ? "block" : "none";
            } else {
                authorisationSucceed = false;
				document.getElementById('helloPanel').style.display = "none";
				document.getElementById('helloInactive').style.display = "block";
            }
        }

        function enter_click(animate) {
            var needSlice = (document.location.href.indexOf("http://") != -1);
            var url = document.location.href.slice(0, document.location.href.lastIndexOf("/") + 1);
            url = "http://workstation.itschool.ssau.ru/account/logon/?extUrl=" + (needSlice ? url.slice(7) : url) + "openid";
            ITHASBEGUN = true;
            var left = 0; 
            var angle = 0;
            var eleft = -176;
            var authorisationWindow;
            clearInterval(enterTimer);  
            function move() { 
                if (angle <= 90 && animate) {
                    canvas_rotate.call(img, angle);
                    angle += 10;
                }
                else {
                    if (left > -700 && animate) {
                        left -= 30;
                        eleft -= 30;
                        document.getElementById('doorl').style.left = left + 'px';
                        document.getElementById('doorr').style.left = 406 - left + 'px';
                        document.getElementById('container').style.marginLeft = eleft + 'px';
                    } else {
                        if (contentType == 0) {
                            if (authorisationNotStarted) {
                                var offsetLeft = window.screenX + (window.outerWidth - window.innerWidth) / 2;
                                var offsetTop = window.screenY + (window.outerHeight - window.innerHeight) - 5;
                                var obj = document.getElementById('mainDoors');
                                do {
                                    offsetLeft += obj.offsetLeft;
                                    offsetTop += obj.offsetTop;
                                } while (obj = obj.offsetParent)
                                var awLeft = offsetLeft;
                                var awTop = offsetTop;
                                //var authorisationWindow = window.open(url, '_blank', 'height=399, width=809, top=' + awTop + ', left=' + awLeft + ', scrollable=no, menubar=no, resizable=no, location=no');
                                authorisationWindow = window.open(url, '_blank', 'fullscreen=yes, scrollable=no, menubar=no, resizable=no, location=no');
                                authorisationWindow.focus();
                                authorisationWindow.onload = new function () {
                                    var awWidth = authorisationWindow.window.outerWidth;
                                    var awHeight = authorisationWindow.window.outerHeight;
                                    var awInnerWidth = authorisationWindow.window.innerWidth;
                                    var awInnerHeight = authorisationWindow.window.innerHeight;
                                    //alert(awWidth + " " + awHeight);
                                    awWidth = awInnerWidth - awWidth;
                                    awHeight = awInnerHeight - awHeight;
                                    //alert(awWidth + " " + awHeight);
                                    //authorisationWindow.window.resizeBy(awWidth, awHeight);
                                }
                                authorisationNotStarted = false;
                            } else {
                                if (authorisationWindow == null || authorisationWindow.closed) {
                                    clearInterval(timer);
                                    document.getElementById('awaitingAuthorisation').style.display = 'none';
                                    document.getElementById('awaitingLoading').style.display = 'none';
                                    document.getElementById('error').style.display = 'block';
                                }
                                document.getElementById('mainDoors').style.display = 'none';
                                if (authorisationComplete) {
                                    
                                    clearInterval(timer);
                                    if (authorisationSucceed) {
                                        document.getElementById('awaitingAuthorisation').style.display = 'none';
                                        document.getElementById('awaitingLoading').style.display = 'block';
                                        document.getElementById('error').style.display = 'none';
                                        document.getElementById("videoPlayer").style.display = 'none';
                                        startUnityPlayer();
                                    } else {
                                        document.getElementById('awaitingAuthorisation').style.display = 'none';
                                        document.getElementById('awaitingLoading').style.display = 'none';
                                        document.getElementById('error').style.display = 'block';
                                    }

                                }
                            }
                        } else if (contentType == 1) {
                            document.getElementById('awaitingAuthorisation').style.display = 'none';
                            document.getElementById('awaitingLoading').style.display = 'block';
                            document.getElementById('error').style.display = 'none';
                            document.getElementById('mainDoors').style.display = 'none';
                            document.getElementById("videoPlayer").style.display = 'none';
                            startUnityPlayer();
                        } else if (contentType == 2) {
                            document.getElementById('loadingContainer').style.display = 'none';
                            document.getElementById('mainDoors').style.display = 'none';
                            document.getElementById("unityPlayer").style.display = 'none';
                        } 
                    }
                }
            }
            timer = setInterval(move, 50) 
        }
		
		function openAuthWindow() {
			authorisationComplete = false;
			authorisationNotStarted = true;
			authorisationSucceed = false;
			contentType = 0;
			enter_click(false);
		}


        var enterTimer;

        function enter_animate() {
            if (ITHASBEGUN) {
                return;    
            }
            clearInterval(enterTimer); 
            var frames = document.getElementById("container").children;
            function move() {
                if (ITHASBEGUN) {
                    return;
                }
                frame++;
                if (frame == 13) {
                    frame = 7;
                }
                img.src = frames[frame].src;
                canvas_rotate.call(img, 0);
            }
            enterTimer = setInterval(move, 70);
        }

        function enter_stop() {
            if (ITHASBEGUN) {
                return;
            }
            clearInterval(enterTimer);
            var frames = document.getElementById("container").children;
            function move() {
                if (ITHASBEGUN) {
                    return;
                }
                if (frame < 1) {
                    clearInterval(enterTimer);
                    frame = 1;    
                }
                frame--;
                img.src = frames[frame].src;
                canvas_rotate.call(img, 0);

            }
            enterTimer = setInterval(move, 70);
        }

        function demo_video() {
            document.getElementById("awaitingAuthorisation").style.display = "none";
            document.getElementById("awaitingLoading").style.display = "block";
            contentType = 2;
            enter_click(true);
        }

        function demo_game() {
            document.getElementById("awaitingAuthorisation").style.display = "none";
            document.getElementById("awaitingLoading").style.display = "block";
            contentType = 1;
            enter_click(true);
        }
    </script>
    <script type="text/javascript" src="@Url.Content("~/Scripts/render.js")"></script>
}
@section topPanel{
    
    <div class="toppanel">
        <div class="toppanelleft">
            <a href="render">
                <img src="/ils2/Content/Sprites/button_main_a.png">
                <p align="center" style="position:absolute;top:-6px;left:13px;display:block;font-size: 13px;color: #eeeeee;letter-spacing:0.8px;line-height:30px;font-family: Futurica">Главная</p>
            </a>
        </div>
        <div class="toppanelcenter">
            <a href="about">
                <img src="/ils2/Content/Sprites/button_about_ia.png">
                <p align="center" style="position:absolute;top:-6px;left:5px;display:block;font-size: 13px;color: #eeeeee;letter-spacing:0.8px;line-height:30px;font-family: Futurica">О проекте</p>
            </a>
        </div>
        <div class="toppanelright">
            <a href="contacts">
                <img src="/ils2/Content/Sprites/button_contact_ia.png">
                <p align="center" style="position:absolute;top:-6px;left:9px;display:block;font-size: 13px;color: #eeeeee;letter-spacing:0.8px;line-height:30px;font-family: Futurica">Контакты</p>
            </a>
        </div>
    </div>
}
@section renderArea{
    
    <div class="unityarea">   
        <img id="updater" src="/ils2/Content/Sprites/black_back.png" style="display:block; position:absolute;top:0px;left:0px;">
        <div class="loading" id="loadingContainer" style="overflow:visible">
            <img src="/ils2/Content/Sprites/loading/loading_1.png" style="display:block">
            <img src="/ils2/Content/Sprites/loading/loading_2.png" style="display:none">
            <img src="/ils2/Content/Sprites/loading/loading_3.png" style="display:none">
            <img src="/ils2/Content/Sprites/loading/loading_4.png" style="display:none">
            <img src="/ils2/Content/Sprites/loading/loading_5.png" style="display:none">
            <img src="/ils2/Content/Sprites/loading/loading_6.png" style="display:none">
            <img src="/ils2/Content/Sprites/loading/loading_7.png" style="display:none">
            <img src="/ils2/Content/Sprites/loading/loading_8.png" style="display:none">
            <img src="/ils2/Content/Sprites/loading/loading_9.png" style="display:none">
            <img src="/ils2/Content/Sprites/loading/loading_10.png" style="display:none">
            <img src="/ils2/Content/Sprites/loading/loading_11.png" style="display:none">
            <img src="/ils2/Content/Sprites/loading/loading_12.png" style="display:none">
            <img src="/ils2/Content/Sprites/loading/loading_13.png" style="display:none">
            <img src="/ils2/Content/Sprites/loading/loading_14.png" style="display:none">
            <img src="/ils2/Content/Sprites/loading/loading_15.png" style="display:none">
            <img src="/ils2/Content/Sprites/loading/loading_16.png" style="display:none">
            <img src="/ils2/Content/Sprites/loading/loading_17.png" style="display:none">
            <img src="/ils2/Content/Sprites/loading/loading_18.png" style="display:none">
            <img src="/ils2/Content/Sprites/loading/loading_19.png" style="display:none">
            <img src="/ils2/Content/Sprites/loading/loading_20.png" style="display:none">
            <img src="/ils2/Content/Sprites/loading/loading_21.png" style="display:none">
            <img src="/ils2/Content/Sprites/loading/loading_22.png" style="display:none">
            <img src="/ils2/Content/Sprites/loading/loading_23.png" style="display:none">
            <img src="/ils2/Content/Sprites/loading/loading_24.png" style="display:none">
            <img src="/ils2/Content/Sprites/loading/loading_25.png" style="display:none">
            <img src="/ils2/Content/Sprites/loading/loading_26.png" style="display:none">
            <img src="/ils2/Content/Sprites/loading/loading_27.png" style="display:none">
            <img src="/ils2/Content/Sprites/loading/loading_28.png" style="display:none">
            <img src="/ils2/Content/Sprites/loading/loading_29.png" style="display:none">
            <img src="/ils2/Content/Sprites/loading/loading_30.png" style="display:none">
            <img src="/ils2/Content/Sprites/loading/loading_31.png" style="display:none">
            <img src="/ils2/Content/Sprites/loading/loading_32.png" style="display:none">
            <img src="/ils2/Content/Sprites/loading/loading_33.png" style="display:none">
            <img src="/ils2/Content/Sprites/loading/loading_34.png" style="display:none">
            <img src="/ils2/Content/Sprites/loading/loading_35.png" style="display:none">
            <img src="/ils2/Content/Sprites/loading/loading_36.png" style="display:none">
            <img src="/ils2/Content/Sprites/loading/loading_37.png" style="display:none">
            <img src="/ils2/Content/Sprites/loading/loading_38.png" style="display:none">
            <img src="/ils2/Content/Sprites/loading/loading_39.png" style="display:none">
            <img src="/ils2/Content/Sprites/loading/loading_40.png" style="display:none">
            <img src="/ils2/Content/Sprites/loading/loading_41.png" style="display:none">
            <img src="/ils2/Content/Sprites/loading/loading_42.png" style="display:none">
            <img src="/ils2/Content/Sprites/loading/loading_43.png" style="display:none">
            <img src="/ils2/Content/Sprites/loading/loading_44.png" style="display:none">
            <img src="/ils2/Content/Sprites/loading/loading_45.png" style="display:none">
            <img src="/ils2/Content/Sprites/loading/loading_46.png" style="display:none">
            <img src="/ils2/Content/Sprites/loading/loading_47.png" style="display:none">
            <img src="/ils2/Content/Sprites/loading/loading_48.png" style="display:none">
            <img src="/ils2/Content/Sprites/loading/loading_49.png" style="display:none">
            <img src="/ils2/Content/Sprites/loading/loading_50.png" style="display:none">
            <p align="center" id="awaitingAuthorisation" style="position:absolute;top:50px;display:block;font-size: large;color: #eeeeee;letter-spacing:0.8px;line-height:30px;font-family: Futurica">Ожидается авторизация пользователя</p>
            <p align="center" id="awaitingLoading" style="position:absolute;top:80px;left:65px;display:none;font-size: large;color: #eeeeee;letter-spacing:0.8px;line-height:30px;font-family: Futurica">Загрузка</p>
			<div id="error" style="display:none">
				<p align="center" style="cursor: pointer;position:absolute;top:60px;left:70px;font-size: 20px;color: #eeeeee;letter-spacing:0.8px;line-height:30px;font-family: Futurica" onclick="javascript:openAuthWindow()">Ошибка</p>
				<p align="center" style="cursor: pointer;position:absolute;top:100px;left:40px;font-size: 14px;color: #eeeeee;letter-spacing:0.8px;line-height:20px;font-family: Futurica" onclick="javascript:openAuthWindow()">попробуйте еще раз</p>
				<img src="/ils2/Content/Sprites/refresh.png" style="cursor: pointer; position:absolute; top: 145px; left: 102px;" onclick="javascript:openAuthWindow()">
			</div>
		</div>
        <div id="unityPlayer" style="width: 809px; height: 400px; position: static">
        </div>
        <div id="videoPlayer" style="width: 809px; height: 400px; position: static">
        </div>
    </div>
    <div class="renderarea" id="mainDoors">
        <div class="doorleft" id="doorl">
            <img src="/ils2/Content/Sprites/door_left.jpg">
        </div>
        <div class="doorright" id="doorr">
            <img src="/ils2/Content/Sprites/door_right.jpg">
        </div>
        <div class="enter" id="container">
            <img src="/ils2/Content/Sprites//enter//enter1.png" id="enter1" style="display: none">
            <img src="/ils2/Content/Sprites//enter//enter2.png" id="enter2" style="display: none">
            <img src="/ils2/Content/Sprites//enter//enter3.png" id="enter3" style="display: none">
            <img src="/ils2/Content/Sprites//enter//enter4.png" id="enter4" style="display: none">
            <img src="/ils2/Content/Sprites//enter//enter5.png" id="enter5" style="display: none">
            <img src="/ils2/Content/Sprites//enter//enter6.png" id="enter6" style="display: none">
            <img src="/ils2/Content/Sprites//enter//enter7.png" id="enter7" style="display: none">
            <img src="/ils2/Content/Sprites//enter//enter8.png" id="enter8" style="display: none">
            <img src="/ils2/Content/Sprites//enter//enter9.png" id="enter9" style="display: none">
            <img src="/ils2/Content/Sprites//enter//enter10.png" id="enter10" style="display: none">
            <img src="/ils2/Content/Sprites//enter//enter11.png" id="enter11" style="display: none">
            <img src="/ils2/Content/Sprites//enter//enter12.png" id="enter12" style="display: none">
            <img src="/ils2/Content/Sprites//enter//enter13.png" id="enter13" style="display: none">
            <canvas id="rotate"></canvas>
        </div>
        <div class="enter" id="container" onclick="javascript:enter_click(true)" onmouseover="javascript:enter_animate()"
            onmouseout="javascript:enter_stop()" style="cursor: pointer;">
        </div>
        <div class="renderOverlayT">
        </div>
        <div class="renderOverlayL">
        </div>
        <div class="renderOverlayR">
        </div>
        <div class="renderOverlayB">
        </div>
    </div>
    
}
